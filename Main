package gym;

import java.util.Scanner;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;

public class Main {
    private static final Scanner sc = new Scanner(System.in);
    private static final DateTimeFormatter DF = DateTimeFormatter.ofPattern("dd/MM/yyyy");

    public static void main(String[] args) {
        GimnasioService servicio = new GimnasioService();

        // Datos de ejemplo
        servicio.altaCliente(new Cliente("12345678", "Ana Pérez", Plan.BASICO, LocalDate.now().minusMonths(3)));
        servicio.altaCliente(new Cliente("23456789", "Juan Gómez", Plan.FULL, LocalDate.now().minusMonths(13)));

        int op;
        do {
            mostrarMenu();
            op = leerEntero("Opción: ");
            try {
                if (op == 1) {
                    alta(servicio);
                } else if (op == 2) {
                    buscar(servicio);
                } else if (op == 3) {
                    modificarNombre(servicio);
                } else if (op == 4) {
                    cambiarPlan(servicio);
                } else if (op == 5) {
                    baja(servicio);
                } else if (op == 6) {
                    listar(servicio);
                } else if (op == 7) {
                    cuota(servicio);
                } else if (op == 8) {
                    altasPorMes(servicio);
                } else if (op == 9) {
                    verLog(servicio);
                } else if (op == 0) {
                    System.out.println("Saliendo...");
                } else {
                    System.out.println("Opción inválida");
                }
            } catch (SocioNoEncontradoException e) {
                System.out.println("ERROR: " + e.getMessage());
            } catch (IllegalArgumentException e) {
                System.out.println("ERROR: " + e.getMessage());
            } catch (Exception e) {
                System.out.println("ERROR inesperado: " + e.getMessage());
            }
        } while (op != 0);
    }

    private static void mostrarMenu() {
        System.out.println();
        System.out.println("=== GIMNASIO (simple) ===");
        System.out.println("1) Alta cliente");
        System.out.println("2) Buscar por DNI");
        System.out.println("3) Modificar nombre");
        System.out.println("4) Cambiar plan");
        System.out.println("5) Baja cliente");
        System.out.println("6) Listar clientes");
        System.out.println("7) Calcular cuota");
        System.out.println("8) Altas por mes");
        System.out.println("9) Ver log");
        System.out.println("0) Salir");
    }

    private static int leerEntero(String prompt) {
        while (true) {
            try {
                System.out.print(prompt);
                return Integer.parseInt(sc.nextLine().trim());
            } catch (Exception e) {
                System.out.println("Ingrese un número válido.");
            }
        }
    }

    private static String leerTexto(String prompt) {
        System.out.print(prompt);
        return sc.nextLine();
    }

    private static LocalDate leerFecha(String prompt) {
        System.out.print(prompt);
        String s = sc.nextLine().trim();
        if (s.isEmpty()) return LocalDate.now();
        try {
            return LocalDate.parse(s, DF);
        } catch (Exception e) {
            System.out.println("Formato inválido, se usará hoy.");
            return LocalDate.now();
        }
    }

    private static Plan leerPlan() {
        System.out.println("Plan: 1=BASICO  2=FULL  3=PREMIUM");
        int n = leerEntero("> ");
        if (n == 1) return Plan.BASICO;
        if (n == 2) return Plan.FULL;
        if (n == 3) return Plan.PREMIUM;
        System.out.println("Opción inválida, se usa BASICO.");
        return Plan.BASICO;
    }

    private static void alta(GimnasioService s) {
        System.out.println("-- Alta cliente --");
        String dni = leerTexto("DNI: ").trim();
        if (s.existeDni(dni)) throw new IllegalArgumentException("Ya existe ese DNI");
        String nombre = leerTexto("Nombre: ");
        Plan plan = leerPlan();
        LocalDate alta = leerFecha("Fecha alta (dd/MM/yyyy) [Enter=hoy]: ");
        s.altaCliente(new Cliente(dni, nombre, plan, alta));
        System.out.println("OK");
    }

    private static void buscar(GimnasioService s) {
        String dni = leerTexto("DNI: ").trim();
        Cliente c = s.buscarPorDni(dni);
        System.out.println(c);
    }

    private static void modificarNombre(GimnasioService s) {
        String dni = leerTexto("DNI: ").trim();
        String nom = leerTexto("Nuevo nombre: ");
        s.modificarNombre(dni, nom);
        System.out.println("OK");
    }

    private static void cambiarPlan(GimnasioService s) {
        String dni = leerTexto("DNI: ").trim();
        Plan p = leerPlan();
        s.cambiarPlan(dni, p);
        System.out.println("OK");
    }

    private static void baja(GimnasioService s) {
        String dni = leerTexto("DNI: ").trim();
        boolean ok = s.baja(dni);
        System.out.println(ok ? "Eliminado" : "No existía");
    }

    private static void listar(GimnasioService s) {
        Cliente[] arr = s.listarOrdenadosPorNombre();
        if (arr.length == 0) System.out.println("(sin clientes)");
        for (int i = 0; i < arr.length; i++) {
            System.out.println(arr[i]);
        }
    }

    private static void cuota(GimnasioService s) {
        String dni = leerTexto("DNI: ").trim();
        double q = s.cuotaDe(dni);
        System.out.println("Cuota: $" + String.format(java.util.Locale.US, "%.2f", q));
    }

    private static void altasPorMes(GimnasioService s) {
        int[] a = s.getAltasPorMes();
        String[] meses = {"Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"};
        for (int i = 0; i < 12; i++) {
            System.out.println(meses[i] + ": " + a[i]);
        }
    }

    private static void verLog(GimnasioService s) {
        String[] lineas = s.logComoLineas();
        if (lineas.length == 0) {
            System.out.println("(log vacío)");
        } else {
            for (int i = 0; i < lineas.length; i++) {
                System.out.println(lineas[i]);
            }
        }
    }
}
